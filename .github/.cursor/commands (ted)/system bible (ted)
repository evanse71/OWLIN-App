Owlin System Bible v1.0

Full Technical & Architectural Specification
(Cursor-ready + Ownerâ€™s inline notes)
 
0  Meta & Global Architecture

Owner Note

Owlin is a fully offline invoice and delivery-verification platform for hospitality venues. It runs entirely on local machinesâ€”no cloud, no remote DBâ€”and uses local OCR and analytics to give Finance, GMs, and Shift Leads a single picture of spend, delivery accuracy, and supplier reliability.
 
0.1  Core Principles
Principle	Description
Offline-first	All functions work without internet. Sync or export is manual.
Local transparency	SQLite DB and JSON logs are human-readable.
Deterministic behaviour	Every action follows a defined input â†’ process â†’ output chain.
Role-aware access	GM / Finance / Shift Lead rights baked into DB + UI.
Graceful failure	No hard crashesâ€”any failure returns a coded message and locked UI state.
 
0.2  Technology Stack
Layer	Technology	License	Reason
Frontend	React 18 + Vite + Tailwind + TanStack Query	MIT	Fast, reactive, offline-buildable
Backend API	FastAPI (Python 3.12+)	MIT	Async, lightweight, easy local serve
Database	SQLite WAL mode (+ DuckDB sidecar analytics)	Public / MIT	File-based, durable, analytics-friendly
OCR Engines	PaddleOCR VL-0.9B â†’ docTR â†’ Tesseract 5.x â†’ Calamari (optional)	Apache 2.0 / MIT	Full coverage, CPU-only
Image Preproc	OpenCV + Pillow-HEIF	BSD / MIT	Deskew + denoise + HEIC decode
Agent Reasoning	Python rules + scikit-learn + local LLM (optional)	BSD / Apache 2.0	Credit/insight generation
UI Wrapper	Tauri (optional)	MIT / Apache 2.0	Desktop packaging, small footprint
 
0.3  Directory Structure
Owlin/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ backend/
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ models/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â””â”€â”€ api/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ owlin.db
â”‚   â”‚   â””â”€â”€ backups/
â”‚   â”œâ”€â”€ license/
â”‚   â”œâ”€â”€ support_packs/
â”‚   â””â”€â”€ updates/
 
0.4  Environment Variables (.env example)
Key	Default	Purpose
OWLIN_ENV	local	Run mode
OCR_ENGINE_PRIMARY	paddleocr	Primary engine
OCR_CONF_GOOD	80	Confidence threshold
OCR_CONF_MIN	70	Low-conf cutoff
PDF_MAX_PAGES	250	Hard limit
UPLOAD_MAX_MB	25	File size limit
SHEPHERD_PATH	data/shepherd/	Shared vault root
DUCKDB_ANALYTICS	true	Enable sidecar DB
AGENT_ENABLED	true	Owlin Agent toggle
PORT_BACKEND	8000	API port
PORT_FRONTEND	5173	UI port
 
1  Data Flow Overview

Owner Note

Everything that happens in Owlin follows one river: Upload â†’ OCR â†’ Parse â†’ Normalize â†’ Match â†’ Detect Issues â†’ Forecast â†’ Dashboard.
Nothing is hidden; every intermediate result is visible on screen or logged locally.
 
1.1  High-Level Pipeline
Stage	Input	Process	Output	Storage
Upload	PDF/JPG/PNG/HEIC	Validate + hash + store	File record	uploaded_files
Preprocess	Raw image	OpenCV deskew + denoise + binarize	Enhanced image	temp cache
OCR	Preprocessed image	PaddleOCR/docTR/Tesseract	Text + boxes + confidence	ocr_pages
Parsing	OCR output	regex + ML rules	supplier, date, total etc.	invoices draft
Normalization	supplier/item strings	rapidfuzz + embedding	canonical IDs	suppliers,items
Matching	invoices vs delivery notes	date + supplier logic	matched pairs	invoice_pairs
Issue Detection	pairs + rules	quantity/price checks	flagged issues	issues
Forecasting	price history	OLS trend + bands	forecasts	supplier_price_history
Dashboard	aggregated tables	analytics queries	KPIs + graphs	DuckDB cache
 
1.2  Timing Budgets
Operation	Target	Max
Upload parse (â‰¤ 10 pages)	< 4 s	6 s
Image receipt OCR	< 5 s	8 s
Dashboard refresh	< 1.5 s	3 s
Forecast update (batch)	< 2 s	5 s
 
1.3  Failure Codes (Top Level)

UPLOAD_FORMAT_UNSUPPORTED | PDF_MAX_PAGES | OCR_LOW_CONFIDENCE | PARSE_TOTALS_MISMATCH | MATCH_NOT_FOUND | DB_WRITE_FAIL | FORECAST_ERROR
 
1.4  Owner Perspective Summary
â€¢	Upload file â†’ instant card appears below.
â€¢	Card shows supplier/date/value/confidence.
â€¢	â€œSubmit to Owlinâ€ locks document and updates dashboard numbers.
â€¢	Low-confidence pages show orange badges and open debug panel.
 

Owlin System Bible v1.0 â€” Part 2
(Backend Specification and Modules)









2  Backend Specification

ğŸ§  Owner Note

Everything behind the Upload button is managed by a chain of Python modules inside /backend/services.
Each one does one job and passes clean data forward. If any step fails, it returns a coded message instead of crashing, so the UI always knows what happened.
 
2.1  Module Map
Module	Purpose	Key Functions	Feeds Into
preproc.py	Clean & normalize images for OCR	deskew(), denoise(), binarize(), enhance_receipt()	engine_select
engine_select.py	Choose best OCR engine based on file type	select_engine(), get_config()	ocr_pipeline
ocr_pipeline.py	Run OCR per page, aggregate results	process_page(), merge_results(), save_meta()	receipt_parser / invoice_parser
receipt_parser.py	Extract data for self-fulfilled receipts	extract_totals(), detect_vat(), classify_self_fulfilled()	normalizer
invoice_parser.py	Extract structured invoice lines	extract_table(), parse_header()	normalizer
classifier.py	Detect document type	classify_doc()	router for parsers
normalizer.py	Supplier & item canonical matching	normalize_supplier(), normalize_item()	match_engine
match_engine.py	Invoice â†” delivery note pairing	find_matches(), score_pairs()	issue_detector
issue_detector.py	Detect mismatches / missing items	detect_price_mismatch(), detect_short_delivery()	DB issues
forecast_engine.py	Price trend prediction	fit_trend(), predict_band()	UI graphs
backup_manager.py	ZIP/WAL backups & restore	create_snapshot(), restore_snapshot()	System Health
license_manager.py	RSA/ECDSA license validation	verify_license()	startup
audit_logger.py	Record every action	log_action(user,event,payload)	audit_log
 
2.2  Core Flow (Upload to DB)
1.	routes/upload.py receives multipart form â†’ validates mime & size â†’ writes to data/uploads â†’ computes SHA-256 hash.
2.	classifier.classify_doc() runs quick heuristics (PDF metadata, text fragments, page layout) â†’ sets document_type.
3.	preproc.* cleans pages â†’ engine_select decides engine.
4.	ocr_pipeline streams pages to engine â†’ stores ocr_pages and confidence scores.
5.	receipt_parser or invoice_parser extracts structured data â†’ temporary JSON â†’ DB draft_invoices.
6.	User reviews card â†’ presses Submit to Owlin â†’ routes/documents.submit() finalizes record and triggers post-processing:
â€ƒâ€¢ normalize supplier/items
â€ƒâ€¢ match delivery notes
â€ƒâ€¢ detect issues
â€ƒâ€¢ update metrics and forecast
â€ƒâ€¢ append audit log
 
2.3  Service Interaction Graph (textual)
upload.py
 â”œâ”€> classifier.py
 â”œâ”€> preproc.py
 â”‚     â””â”€> engine_select.py
 â”‚           â””â”€> ocr_pipeline.py
 â”œâ”€> receipt_parser.py | invoice_parser.py
 â”œâ”€> normalizer.py
 â”œâ”€> match_engine.py
 â”œâ”€> issue_detector.py
 â”œâ”€> forecast_engine.py
 â””â”€> audit_logger.py
 
2.4  OCR Engines & Selection Logic

Priority order:
1.	PaddleOCR (VL-0.9B) â€” default for multi-language PDFs.
2.	docTR â€” triggered when layout = table-dense or multi-column.
3.	Tesseract 5.x â€” fallback for thermal receipts or monochrome scans.
4.	Calamari (optional) â€” printed legacy docs.
if is_receipt:
    engine = "tesseract"
elif layout_score > 0.6:
    engine = "doctr"
else:
    engine = "paddleocr"
 
2.5  Supplier & Item Normalization
â€¢	rapidfuzz.token_sort_ratio() â‰¥ 90 â†’ auto-match
â€¢	85â€“90 â†’ flag for user confirmation
â€¢	<85 â†’ create new supplier record
â€¢	Sentence-transformer embedding fallback for ambiguous cases.

All matches logged in normalization_log table.
 
2.6  Matching Logic (Invoice â†” Delivery Note)
â€¢	Date window Â± 3 days
â€¢	Supplier must match
â€¢	Total difference â‰¤ 1 % or â‰¤ Â£2 absolute
â€¢	Line-item match score > 0.8 â†’ confirmed pair
â€¢	If no pair found â†’ status UNMATCHED â†’ visible in Dashboard â€œUnmatched Notesâ€.
 
2.7  Forecasting Algorithm
â€¢	Source: supplier_price_history (item_id, price_ex_vat, observed_at)
â€¢	Method: Ordinary Least Squares regression
â€¢	Outputs: trend slope, intercept, 95 % confidence band, RÂ².
â€¢	Forecast points 1, 3, 12 months â†’ forecast_points table.
 
2.8  Backup & Shepherd Vault
â€¢	Every save writes WAL + daily ZIP to data/backups/YYYY-MM-DD_HHMM.zip
â€¢	Shepherd folder =data/shepherd/<venue_id>/
â€ƒContains: owlin.db, manifest.json, lockfile.sha256, backups/
â€¢	If another device accesses same vault, lockfile prevents simultaneous write.
â€¢	Integrity check PRAGMA integrity_check runs nightly.
 
2.9  Error Handling Template
try:
    result = process_invoice(file)
except OCRConfidenceError as e:
    return JSONResponse(code="OCR_LOW_CONFIDENCE", detail=str(e))
except ParseError as e:
    return JSONResponse(code="PARSE_TOTALS_MISMATCH", detail=str(e))
except Exception as e:
    log.error(e)
    return JSONResponse(code="SERVER_ERROR", detail="Unhandled exception")
 
2.10  Audit Log Schema
Column	Type	Example
id	INTEGER PK	1
timestamp	TEXT	2025-10-27T13:14:33Z
user	TEXT	gm@venue
event	TEXT	invoice_submit
payload	JSON	{"supplier":"Brakes","total":312.45}
 
2.11  API Routes Summary (Backend)
Endpoint	Method	Purpose
/api/health	GET	Return status + version pins
/api/upload	POST	Upload file, run OCR draft
/api/documents/submit	POST	Finalize docs, trigger analytics
/api/invoices	GET	List filtered invoices
/api/invoices/{id}	GET	Invoice detail
/api/issues	GET/POST	Query or resolve issues
/api/metrics/overview	GET	Dashboard KPIs
/api/forecast/{item_id}	GET	Forecast data
/api/export/issues.csv	GET	CSV export
/api/license/verify	POST	Check license file
 



 
3.9  API â†” Frontend Integration Matrix

(Every endpoint listed with its direct UI consumer so Cursor knows what must refresh together.)
API Endpoint	Consumed By	On-Screen Effect	Notes
/api/health	SystemHealth card + launch banner	Displays build OK + model versions	polled at app start
/api/upload	UploadSection	Adds new card to InvoiceCardsPanel	returns file meta + scan state
/api/documents/submit	UploadSection â†’ global invalidate	Locks cards + refreshes dashboard	atomic commit
/api/invoices	InvoicesPage list	Shows filtered cards	reacts to filters/date range
/api/invoices/{id}	InvoiceDetailBox	Populates line table + issues	used by expand view
/api/issues	FlaggedIssuesBox	Shows open issues	POST resolves issue + refresh
/api/metrics/overview	DashboardPage	Updates KPI tiles	recalculated after submit
/api/forecast/{item}	UniversalTrendGraph	Renders forecast line + band	async load on graph focus
/api/suppliers/:id/scorecard	SupplierScorecard	Supplier summary	triggers after supplier change
/api/export/issues.csv	FlaggedIssuesBox export btn	Downloads CSV	local CSV generator
/api/license/verify	LicenseManager	Locks/unlocks edit features	offline RSA check
 
3.10 Event Propagation and Reactivity

Sequence: â€œSubmit to Owlinâ€ â†’ Dashboard Update
User click
 â””â”€> POST /api/documents/submit
      â”œâ”€ updates invoices/invoice_lines/supplier_price_history
      â”œâ”€ triggers forecast_engine
      â”œâ”€ refresh metrics_daily
      â””â”€ returns touched IDs
Frontend:
 â”œâ”€ optimistic lock of cards
 â”œâ”€ invalidateQueries(["invoices","dashboard","suppliers","forecast"])
 â””â”€ render new KPI values within 1.5 s
Guaranteed reaction order
1.	Invoice cards â†’ locked state
2.	Dashboard KPIs â†’ animated counter update
3.	Unmatched list â†’ filters out resolved docs
4.	Supplier scorecards â†’ refetched only for affected IDs
5.	Forecast graphs â†’ append todayâ€™s point
 
3.11 Category and Product Intelligence (Frontend View)
â€¢	Each invoice_line mapped to an item â†’ category.
â€¢	Category pie graph = SUM(total_ex_vat) GROUP BY category_id for date range.
â€¢	Hovering category filters invoice cards to that category.
â€¢	Clicking product name opens Trend Graph modal with forecast band.
â€¢	Cached queries expire after 10 minutes idle.
 
3.12 Visual Interaction Budget
Event	Max Latency	User Feedback
Upload â†’ Card Visible	< 1.0 s	progress bar + â€œScanningâ€¦â€
OCR Complete â†’ Parsed Data	< 4 s for â‰¤ 10 pages	â€œPreview readyâ€
Submit â†’ Dashboard Update	< 1.5 s	numbers animate
Error â†’ Toast Visible	< 0.2 s	distinct sound + color
Forecast Graph Load	< 1.2 s	skeleton placeholder
 
3.13 Keyboard & Accessibility Shortcuts
â€¢	Ctrl + U / Cmd + U â†’ open Upload dialog
â€¢	Ctrl + F â†’ focus filter bar
â€¢	Enter on selected card â†’ expand Invoice Detail
â€¢	Shift + R â†’ refresh dashboard
â€¢	Alt + E â†’ export issues CSV
All elements WCAG AA contrast; tooltips for icons.
 
3.14 Owner Perspective

The front end behaves like a local desktop finance console:
upload files, watch them convert to cards, press Submit, and the numbers shift in real time.
Every action is instant, traceable, and reversible.
 


 
5  Analytics & Forecasting Engine

ğŸ§  Owner Note

Every number on the Dashboard and Supplier pagesâ€”match rate, spend, price trendâ€”comes from deterministic local analytics.
No cloud BI, no external API.
Everything is computed on your own machine using SQLite + DuckDB + Python.
 
5.1  Data Sources
Source Table	Columns Used	Consumer
invoices, invoice_lines	supplier_id, item_id, total_ex_vat, date	Spend & category pie
issues	type, severity, status	Flagged issue count
supplier_price_history	item_id, price_ex_vat, observed_at	Forecast graphs
metrics_daily	pre-aggregated KPIs	Dashboard tiles
 
5.2  Metric Computation (backend 
metrics_engine.py
)
1.	Spend Total = Î£ (invoice.total_ex_vat) per day/venue
2.	Match Rate = matched invoices Ã· total invoices
3.	Issue Rate = open issues Ã· total docs
4.	Avg Confidence = mean(OCR page confidence)
5.	Volatility Score = Ïƒ(price change % per item)

Results â†’ metrics_daily(venue_id,date,kpi,value)
Frontend reads aggregate over range.
 
5.3  Forecast Computation (backend 
forecast_engine.py
)
for item in items:
    hist = fetch_price_history(item)
    if len(hist) > 3:
        slope, intercept = ols(hist.dates, hist.prices)
        conf_band = compute_95ci(hist.prices)
        save_forecast(item, slope, intercept, conf_band)
UI Graph â†’ actual line (blue) + forecast (broken sage) + band (transparent).
 
5.4  Supplier Scorecard Algorithm
Metric	Formula	Colour Code
Mismatch Rate	mismatched_lines Ã· total_lines	amber > 3 %
Delivery Delays	late deliveries Ã· total deliveries	red > 5 %
Price Volatility	Ïƒ(price change)	amber > 10 %
Issue Resolution Time	avg days(openâ†’closed)	grey > 7 days
 
5.5  Analytics Cache
â€¢	DuckDB mirror refreshed on Submit or when older than 1 hour.
â€¢	Cached queries:
â€¢ dashboard_overview() â€“ 3 s
â€¢ forecast_series(item) â€“ 1 s
â€¢ category_spend() â€“ 0.8 s
 
6  Owlin Agent (Reasoning & Credit Suggestion)

ğŸ§  Owner Note

Owlin Agent acts as a local advisor. It reads flagged issues and OCR confidence and suggests next actionsâ€”credit requests, rescan alerts, or supplier warningsâ€”all offline.
 
6.1  Data Inputs
â€¢	issues table (open and recent)
â€¢	invoice_lines for flagged invoices
â€¢	supplier_price_history (3-month trend)
â€¢	OCR confidence values < 75 %
â€¢	user role (for tone / permissions)
 
6.2  Reasoning Pipeline
1.	Gather â€“ query flagged issues + context.
2.	Classify issue type â†’ PRICE / QUANTITY / DELIVERY / MISC.
3.	Decide Action
â€¢ Price error â†’ draft credit suggestion.
â€¢ Quantity short â†’ mark â€œverify delivery logs.â€
â€¢ Repeated supplier fault â†’ â€œEscalate to Finance.â€
4.	Generate Output (rule or LLM template).
5.	Store Result in agent_suggestions table with confidence score.
 
6.3  Credit Suggestion Engine
Input	Rule	Output
Line total mismatch > Â£1	credit_value = abs(diff)	â€œRequest Â£X credit from Supplierâ€
VAT calc error > 0.5 %	â€œCheck VAT rounding on Supplier invoiceâ€	advice
3 + same issue supplier month	â€œFlag Supplier for reviewâ€	escalation
Optional local LLM (quantized Mistral/Llama â‰¤ 4 GB) to rewrite into email-ready text.
 
6.4  UI Integration
â€¢	Appears as ğŸ§© Agent Panel inside InvoiceDetailBox.
â€¢	Shows suggestions list with confidence badge.
â€¢	Clicking copy icon â†’ copies email draft.
â€¢	Low confidence (< 60 %) â†’ greyed out â€œreview manually.â€
 
6.5  Agent Audit

Each agent decision logged â†’ audit_log (event = â€œagent_suggestionâ€).
User can disable agent in Settings â†’ toggle AGENT_ENABLED=false.
 
7  Defensive & Integrity Systems

ğŸ§  Owner Note

Owlin is built for kitchen-floor conditions â€” power cuts, duplicate files, USB copies. Nothing corrupts the database or loses records.
 
7.1  Integrity Stack
Layer	Tool	Function
Upload	SHA-256 hash	Prevent duplicate files
Database	SQLite WAL mode	Atomic writes
Daily Check	PRAGMA integrity_check	Detect corruption
Shepherd Vault	Manifest + lock file	Multi-device sync safety
Backup	ZIP + sha256 manifest	Versioned restore
 
7.2  Failure Escalation Matrix
Failure	Recovery Action	User Feedback
File hash exists	Skip processing	â€œDuplicate upload ignored.â€
DB write error	Rollback + mark retry	â€œRetry saved data.â€
Integrity fail	Enter Recovery Mode	Banner + restore options
Low disk space	Pause OCR	â€œStorage low â€“ free space.â€
License expired	Lock edit functions	â€œRead-only mode.â€
 
7.3  Backup and Restore Protocol
1.	On backup trigger:
owlin.db + audit_log + version_log â†’ ZIP.
2.	Compute sha256 â†’ manifest.json.
3.	Store under data/backups/DATE_TIME.zip.
4.	Restore mode in UI â†’ select backup â†’ confirm â†’ import.
5.	Conflicts resolved via render_table_diff() UI.
 
7.4  System Health Checks
Check	Frequency	Result
API status (/api/health)	every 30 s	badge green/red
DB integrity	daily on launch	modal on fail
OCR model hashes	on startup	displayed in System Health
Shepherd lock	before write	prevents multi-edit
 
7.5  Version Log Example
Module	Version Hash	Date
paddleocr	b8f7e4a	2025-10-20
doctr	1d39fe2	2025-10-20
tesseract	5.4.1-eng	2025-10-20
backend schema	v1.0.0	2025-10-27
Displayed via System Health â†’ â€œVersions.â€		
 
7.6  Security and Permissions
â€¢	Users stored with bcrypt password hash.
â€¢	Roles enforced in API via dependency injection.
â€¢	Local requests only (CORS: localhost 127.0.0.1).
â€¢	File paths sandboxed to data/uploads/.
 
7.7  System Limits
Parameter	Limit	Rationale
Upload size	25 MB	offline performance
Pages per PDF	250	memory bound
Concurrent uploads	4	CPU budget
Forecast window	12 months	UX clarity
Backups retained	30 days	storage efficiency
 

 
8  Acceptance & Validation Framework

ğŸ§  Owner Note

Every build of Owlin must pass this table before release.
If all tests succeed, the app is guaranteed to:
â€¢	read any PDF / image invoice,
â€¢	update all analytics instantly,
â€¢	maintain database integrity,
â€¢	recover from power loss,
â€¢	and never show an undefined state.
 
8.1  Functional Test Matrix
#	Scenario	Action	Expected Result	Threshold
1	PDF invoice (2 pages)	Upload â†’ Submit	Supplier/date/total extracted; conf â‰¥ 80	Pass â‰¥ 80
2	Complex table invoice	Upload	docTR triggered; all rows parsed	conf â‰¥ 75
3	Thermal receipt (JPG)	Upload â†’ Submit	Receipt classified SELF-FULFILLED; total accurate	conf â‰¥ 70
4	HEIC receipt	Upload â†’ auto-convert	Handled via Pillow-HEIF; same result as JPG	no error
5	250-page PDF	Upload	Rejected with PDF_MAX_PAGES	error shown
6	Unmatched invoice	Submit	Appears in Dashboard Unmatched list	visible within 1.5 s
7	Price mismatch	Submit	Issue created â†’ Flagged Issues panel	1 row added
8	Resolve issue	Click resolve	Issue status â†’ closed; dashboard count -1	sync â‰¤ 1.5 s
9	Forecast update	Submit invoice with item X	Dashboard trend graph adds today point	delay â‰¤ 2 s
10	Agent suggestion	Flag price error	Agent shows credit value recommendation	text generated
11	Backup restore	Run manual backup â†’ restore	DB and metrics identical post-restore	diff = 0
12	Integrity fail simulation	Corrupt DB	Recovery mode activates	banner shown
13	License expiry	Expire file	UI read-only	no writes
 
8.2  Performance Benchmarks
Operation	Target	Max Acceptable
Upload â†’ Card visible	< 1 s	2 s
OCR (â‰¤ 10 pages)	< 4 s	6 s
Submit â†’ Dashboard update	< 1.5 s	3 s
Forecast recalc (batch 50 items)	< 2 s	5 s
Full backup ZIP creation	< 3 s	5 s
 
8.3  Regression Guards
â€¢	Smoke test for each endpoint â†’ HTTP 200.
â€¢	DB integrity check = ok.
â€¢	No duplicate hashes in uploaded_files.
â€¢	UI snapshot diff < 0.1 %.
 
9  Appendices

9.1  Environment File (.env.example)
OWLIN_ENV=local
OCR_ENGINE_PRIMARY=paddleocr
OCR_CONF_GOOD=80
OCR_CONF_MIN=70
PDF_MAX_PAGES=250
UPLOAD_MAX_MB=25
SHEPHERD_PATH=data/shepherd/
DUCKDB_ANALYTICS=true
AGENT_ENABLED=true
PORT_BACKEND=8000
PORT_FRONTEND=5173
 
9.2  Model Version Table
Engine	Model / Langdata	Hash	Date
PaddleOCR VL-0.9B	ppocrv5_multilang	b8f7e4a	2025-10-20
docTR	doctr_db_resnet50	1d39fe2	2025-10-20
Tesseract	eng.traineddata v5.4.1	5x9af4c	2025-10-20
Calamari	latin_printed	0c23ba7	2025-10-20
 
9.3  Error Code Reference
Code	Meaning	User Action
UPLOAD_FORMAT_UNSUPPORTED	File type not PDF/JPG/PNG/HEIC	Upload valid format
PDF_MAX_PAGES	PDF too large	Split file
OCR_LOW_CONFIDENCE	Page conf < 70	Review text
PARSE_TOTALS_MISMATCH	Total calc error	Check invoice
MATCH_NOT_FOUND	No delivery note	Manual pair
DB_WRITE_FAIL	SQLite write error	Retry
FORECAST_ERROR	Trend fit failed	Ignore update
LICENSE_EXPIRED	License invalid	Renew file
INTEGRITY_FAIL	DB corruption	Restore backup
 
9.4  Fixture Set (for tests)
â€¢	/fixtures/pdf/invoice_simple.pdf
â€¢	/fixtures/pdf/invoice_table.pdf
â€¢	/fixtures/img/receipt_thermal.jpg
â€¢	/fixtures/img/receipt_crumpled.jpg
â€¢	/fixtures/img/receipt_heic.heic
â€¢	/fixtures/pdf/invoice_large.pdf
 
9.5  Third-Party Licenses

All open-source components used under MIT / Apache 2.0 / BSD / Public Domain licenses:
â€¢	FastAPI, React, Vite, Tailwind, TanStack Query â€“ MIT
â€¢	PaddleOCR, docTR, Tesseract, Calamari, OpenCV, Pillow-HEIF â€“ Apache 2.0 / MIT / BSD
â€¢	DuckDB, SQLite â€“ MIT / Public Domain
â€¢	cryptography, PyCryptodome â€“ Apache 2.0 / BSD
â€¢	scikit-learn, rapidfuzz, sentence-transformers â€“ BSD / MIT / Apache 2.0
 
9.6  Glossary
Term	Definition
Shepherd Vault	Shared venue folder holding SQLite DB + manifest + backups.
Confidence	Average OCR trust score (0â€“100 %).
Flagged Issue	Detected mismatch requiring manual check.
Forecast Band	Predicted price range (95 % confidence).
Agent Suggestion	Automated credit or action recommendation by Owlin Agent.
Limited Mode	Read-only state when license invalid or vault locked.
Support Pack	ZIP export containing DB + logs for diagnostics.
 
9.7  Release Checklist
1.	âœ… Run all 13 acceptance tests.
2.	âœ… Verify model hashes in /api/health.
3.	âœ… Confirm Shepherd manifest present and valid.
4.	âœ… Generate support pack ZIP before shipping.
5.	âœ… Tag Git commit with version hashes.
 
9.8  Owner Closing Note

When all boxes are green, Owlin is production-ready.
Every button, every card, every number is reproducible from the information inside this document.
Cursor can rebuild the entire system from these pages alone.
 



















 
Appendix B â€“ Architectural Audit & Hardening Plan

(Post-specification production-readiness review conducted October 2025.)
 
B.1 Executive Critique

Owlinâ€™s current architecture is fundamentally strong:
â€¢	Deterministic, fully offline design
â€¢	Clean module isolation (upload â†’ OCR â†’ parse â†’ store â†’ analyze â†’ display)
â€¢	Robust audit and recovery mechanisms
â€¢	Role-aware UI and permissions

However, to reach true â€œunbreakableâ€ commercial-grade reliability, several subsystems must be reinforced: concurrent writes, OCR fallback automation, alias-learning, backup UX, and live monitoring.
 
B.2 Critical System Improvements

1 Database Reliability (WAL + Shared Vault)
â€¢	Risk: SQLite WAL over SMB/NAS may corrupt under simultaneous writes.
â€¢	Action â†’ Implement enforced single-writer tokens; evaluate LiteFS/Litestream replication if concurrent editing is essential.

2 OCR Pipeline Robustness
â€¢	Risk: fallback path too shallow.
â€¢	Action â†’ Add ocr_triage.py queue that auto-reruns low-confidence pages with alternate preprocessing + engine; log all retries.

3 Supplier Normalization Enhancement
â€¢	Risk: alias drift and manual cleanup debt.
â€¢	Action â†’ Create supplier_alias_review table + UI panel prompting user to confirm new vendor strings.

4 Backup / Restore UX
â€¢	Risk: blind restores.
â€¢	Action â†’ Build Backup Browser Modal with timeline slider + JSON diff preview; require confirmation before overwrite.

5 Multi-User Concurrency
â€¢	Risk: simultaneous writers corrupt data.
â€¢	Action â†’ Use startup check in vault_lock.py to issue edit token; refuse secondary write sessions.

6 System Health Monitoring
â€¢	Risk: silent stalls or disk exhaustion.
â€¢	Action â†’ Add health_watchdog.py (Python watchdog) monitoring uploads folder, disk space, and process liveness; expose /api/system/health/live.

7 UX & Error Handling
â€¢	Risk: passive error toasts.
â€¢	Action â†’ Replace with contextual modals (â€œRecover from backup?â€ / â€œSplit file now?â€) + log user choices to audit trail.

8 Security & Licensing
â€¢	Risk: potential local tampering.
â€¢	Action â†’ Store license manifest hashes; extend auth.py to argon2id rehash policy with salt rotation.

9 Performance & Scalability
â€¢	Risk: UI thrash at >10 k records.
â€¢	Action â†’ Implement chunked background processing, throttle TanStack Query invalidations, guard against memory exhaustion with cool-down logic.
 
B.3 Red Flag Risks
Category	Description	Required Safeguard
File-based Concurrency	SQLite over SMB	Single-writer token or LiteFS
Restore Process	No dry-run preview	Mandatory diff preview
OCR Preprocessing	Aggressive filters	Configurable per type
Supplier Alias	Drift over time	Monthly review UI
Credentials & Licenses	Weak storage	Argon2id rehash + manifest hash
 
B.4 Integration Tasks
Module	File / Component	Function
backend	ocr_triage.py	OCR retry queue and logging
backend	vault_lock.py	Single-writer token enforcement
backend	health_watchdog.py	Folder + process monitor
frontend	BackupBrowserModal.tsx	Interactive restore UI
frontend	SupplierAliasReviewPanel.tsx	Vendor alias approval panel
docs	Appendix_B_Architectural_Hardening.md	This plan as stand-alone doc
 
B.5 Action Checklist for Final Cursor Sprint
#	Task	Owner	Status
1	Add LiteFS or single-writer token	Backend	â˜
2	Build OCR Triage Queue	Backend	â˜
3	Implement Alias Review Panel	Frontend	â˜
4	Add Backup Browser Modal	Frontend	â˜
5	Integrate Watchdog Health Monitor	Backend	â˜
6	Replace error toasts with context modals	Frontend	â˜
7	Enforce argon2id rehash policy	Backend	â˜
8	Stress-test 10 k+ records and optimize cache	QA	â˜
Mark all â˜‘ before tagging release v1.1.0.
 
B.6 Summary Judgment

Owlin now meets professional offline-software engineering standards.
Final focus:
â€¢	Lock the vault (no concurrent writes)
â€¢	Preview before restore
â€¢	Automate triage + monitoring
â€¢	Keep supplier mappings clean
â€¢	Secure everything by default

When all items in Â§ B.5 are green, Owlin achieves â€œdeterministic commercial-grade resilience.â€
 



















